{% extends 'base.html' %}

{% block content %}
<div>
    <p>Upload a PowerPoint (.pptx) file to compress its images and videos.</p>
    
    <form method="post" enctype="multipart/form-data" id="upload-form">
        <div class="form-group">
            <label for="file">Select PowerPoint file:</label>
            <input type="file" name="file" id="file" accept=".ppt,.pptx" required>
        </div>
        
        <div class="parameters">
            <h3>Compression Parameters</h3>
            
            <div class="form-group">
                <label for="image_scale">Image Scale (%):</label>
                <div class="slider-container">
                    <input type="range" name="image_scale" id="image_scale" min="0.1" max="1" step="0.05" value="0.5" oninput="updateImageScaleValue(this.value)">
                    <span id="image_scale_value">50%</span>
                </div>
                <small>Lower values = smaller file size, but lower image quality</small>
            </div>
            
            <div class="form-group">
                <label for="image_quality">Image Quality:</label>
                <div class="slider-container">
                    <input type="range" name="image_quality" id="image_quality" min="10" max="100" step="5" value="70" oninput="updateImageQualityValue(this.value)">
                    <span id="image_quality_value">70</span>
                </div>
                <small>Lower values = smaller file size, but lower image quality</small>
            </div>
            
            <div class="form-group">
                <label for="video_crf">Video Quality (CRF):</label>
                <div class="slider-container">
                    <input type="range" name="video_crf" id="video_crf" min="18" max="35" step="1" value="28" oninput="updateVideoCRFValue(this.value)">
                    <span id="video_crf_value">28</span>
                </div>
                <small>Lower values = higher quality, but larger file size (18-28 recommended)</small>
            </div>
            
            <div class="form-group">
                <label for="video_preset">Video Compression Speed:</label>
                <select name="video_preset" id="video_preset">
                    <option value="ultrafast">Ultrafast (Lower Compression)</option>
                    <option value="superfast">Superfast</option>
                    <option value="veryfast">Very Fast</option>
                    <option value="faster">Faster</option>
                    <option value="fast">Fast</option>
                    <option value="medium" selected>Medium (Balanced)</option>
                    <option value="slow">Slow</option>
                    <option value="slower">Slower</option>
                    <option value="veryslow">Very Slow (Better Compression)</option>
                </select>
                <small>Slower presets = better compression, but longer processing time</small>
            </div>
        </div>
        
        <!-- Terms and Conditions Checkbox -->
        <div class="form-group terms-checkbox">
            <input type="checkbox" id="terms-consent" name="terms-consent" required>
            <label for="terms-consent">I agree to the <a href="#" id="terms-link">Terms and Conditions</a></label>
        </div>
        
        <button type="submit" id="submit-btn" disabled>Compress PowerPoint</button>
    </form>
    
    <!-- Terms and Conditions Modal -->
    <div id="terms-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Terms and Conditions</h2>
            <div class="terms-content">
                <h3>Privacy Policy</h3>
                <p>This service does not store or save your uploaded files for longer than necessary to process them. All files are automatically deleted after you download the compressed version or after a short period of inactivity.</p>
                
                <h3>How We Compress PowerPoint Files</h3>
                <p>Our compression process works by:</p>
                <ol>
                    <li>Reducing the size and quality of images according to your selected parameters</li>
                    <li>Re-encoding videos with more efficient settings</li>
                    <li>Maintaining the original structure and functionality of your presentation</li>
                </ol>
                
                <h3>Limitations</h3>
                <p>While we strive to maintain the quality of your presentations, compression inherently involves some quality reduction to achieve smaller file sizes. Very complex presentations may experience some layout shifts or formatting changes.</p>
                
                <h3>User Responsibility</h3>
                <p>By using this service, you acknowledge that:</p>
                <ul>
                    <li>You have the right to use and modify the files you upload</li>
                    <li>You should always keep a backup of your original files</li>
                    <li>You understand that compression is a trade-off between file size and quality</li>
                </ul>
            </div>
            <button id="accept-terms">I Accept</button>
        </div>
    </div>
    
    <!-- Progress Bar Container -->
    <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
        <p class="status-message" id="status-message">Preparing to process...</p>
    </div>
    
    <!-- Log Display Area -->
    <div class="log-container" id="log-container" style="display: none;">
        <h3>Process Logs</h3>
        <pre id="log-content" class="log-content"></pre>
        <button id="toggle-logs-btn" onclick="toggleLogs()">Hide Logs</button>
        <button id="refresh-logs-btn" onclick="fetchLogs()">Refresh Logs</button>
    </div>
</div>

<script>
    // Terms and Conditions Modal Functions
    const modal = document.getElementById('terms-modal');
    const termsLink = document.getElementById('terms-link');
    const closeModal = document.getElementsByClassName('close-modal')[0];
    const acceptButton = document.getElementById('accept-terms');
    const termsCheckbox = document.getElementById('terms-consent');
    const submitButton = document.getElementById('submit-btn');
    
    // Open modal when clicking on terms link
    termsLink.addEventListener('click', function(e) {
        e.preventDefault();
        modal.style.display = 'block';
    });
    
    // Close modal when clicking X
    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Accept terms and check the checkbox
    acceptButton.addEventListener('click', function() {
        termsCheckbox.checked = true;
        modal.style.display = 'none';
        updateSubmitButton();
    });
    
    // Enable/disable submit button based on checkbox
    termsCheckbox.addEventListener('change', updateSubmitButton);
    
    function updateSubmitButton() {
        submitButton.disabled = !termsCheckbox.checked;
    }

    // Update sliders values
    function updateImageScaleValue(val) {
        document.getElementById('image_scale_value').textContent = Math.round(val * 100) + '%';
    }
    
    function updateImageQualityValue(val) {
        document.getElementById('image_quality_value').textContent = val;
    }
    
    function updateVideoCRFValue(val) {
        document.getElementById('video_crf_value').textContent = val;
    }
    
    // Log display functionality
    function toggleLogs() {
        const logContent = document.getElementById('log-content');
        const toggleBtn = document.getElementById('toggle-logs-btn');
        
        if (logContent.style.display === 'none') {
            logContent.style.display = 'block';
            toggleBtn.textContent = 'Hide Logs';
            fetchLogs(); // Refresh logs when showing
        } else {
            logContent.style.display = 'none';
            toggleBtn.textContent = 'Show Logs';
        }
    }
    
    function fetchLogs() {
        fetch('/logs')
            .then(response => response.json())
            .then(data => {
                document.getElementById('log-content').textContent = data.logs.join('\n');
                document.getElementById('log-container').style.display = 'block';
            })
            .catch(error => console.error('Error fetching logs:', error));
    }
    
    // Auto-refresh logs during processing
    let logRefreshInterval;
    
    function startLogRefresh() {
        logRefreshInterval = setInterval(fetchLogs, 2000); // Refresh logs every 2 seconds
    }
    
    function stopLogRefresh() {
        clearInterval(logRefreshInterval);
    }
    
    // Progress tracking functionality
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const submitBtn = document.getElementById('submit-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const statusMessage = document.getElementById('status-message');
        
        // Initialize submit button state
        updateSubmitButton();
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file');
            if (!fileInput.files[0]) {
                alert('Please select a file first.');
                return;
            }
            
            // Verify terms checkbox is checked
            if (!termsCheckbox.checked) {
                alert('Please agree to the Terms and Conditions before proceeding.');
                return;
            }
            
            // Show progress bar and logs
            progressContainer.style.display = 'block';
            document.getElementById('log-container').style.display = 'block';
            document.getElementById('log-content').style.display = 'block';
            submitBtn.disabled = true;
            
            // Start refreshing logs automatically
            startLogRefresh();
            
            // Create FormData object
            const formData = new FormData(form);
            
            // Create XMLHttpRequest
            const xhr = new XMLHttpRequest();
            
            // Track upload progress (file upload phase)
            xhr.upload.addEventListener('progress', function(event) {
                if (event.lengthComputable) {
                    // This is just the upload progress, not the processing progress
                    const percentComplete = Math.round((event.loaded / event.total) * 30); // Up to 30%
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    statusMessage.textContent = 'Uploading file...';
                    fetchLogs(); // Fetch logs during upload
                }
            });
            
            // Handle response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // Success - either we got the finished result or a task ID to poll
                        try {
                            const response = JSON.parse(xhr.responseText);
                            
                            if (response.status === 'complete') {
                                // Compression completed
                                progressBar.style.width = '100%';
                                progressBar.textContent = '100%';
                                statusMessage.textContent = 'Compression complete! Redirecting...';
                                stopLogRefresh();
                                window.location.href = response.redirect_url;
                            } else if (response.status === 'processing') {
                                // We need to poll for status
                                pollTaskStatus(response.task_id);
                            }
                        } catch (e) {
                            // Not JSON, probably HTML response
                            stopLogRefresh();
                            window.location.href = "/download";
                        }
                    } else {
                        // Error
                        statusMessage.textContent = 'Error: ' + xhr.statusText;
                        submitBtn.disabled = false;
                        stopLogRefresh();
                    }
                }
            };
            
            // Send the form
            xhr.open('POST', '/upload', true);
            xhr.send(formData);
        });
        
        // Function to poll for task status
        function pollTaskStatus(taskId) {
            const statusCheck = setInterval(function() {
                fetch('/task_status/' + taskId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'processing') {
                            // Update progress
                            const progress = 30 + Math.round(data.progress * 70); // 30% was upload, rest is processing
                            progressBar.style.width = progress + '%';
                            progressBar.textContent = progress + '%';
                            statusMessage.textContent = data.message || 'Processing...';
                            fetchLogs(); // Fetch logs during processing
                        } else if (data.status === 'complete') {
                            // Task completed
                            clearInterval(statusCheck);
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            statusMessage.textContent = 'Compression complete! Redirecting...';
                            stopLogRefresh();
                            window.location.href = data.redirect_url;
                        } else if (data.status === 'error') {
                            // Error occurred
                            clearInterval(statusCheck);
                            statusMessage.textContent = 'Error: ' + data.error;
                            submitBtn.disabled = false;
                            stopLogRefresh();
                        }
                    })
                    .catch(error => {
                        clearInterval(statusCheck);
                        statusMessage.textContent = 'Error checking status: ' + error;
                        submitBtn.disabled = false;
                        stopLogRefresh();
                    });
            }, 1000); // Check every 1 second
        }
    });
</script>
{% endblock %}